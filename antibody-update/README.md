# RosettaAntibody Database

RosettaAntibody is a hybrid homology/_de novo_ modeling approach for
predicting antibody structure. As such, it is highly dependent on a
database for antibody CDR and Framework templates.

The below text is true for the following git shas/branches:
- rosetta/main: lqtza/scs_blast_updates_for_auto_db, 4db3fed871
- rosetta/tools: lqtza/update-ab-db, [insert sha]

## Database Contents

Briefly, the database has four categories of contents:

- PDBs
    - Chothia numbered
- BLAST databases
    - Generated by extracting sequences from the above PDBs.
- "Info" files
    - Generated by extracting sequences from the above PDBs.
    - Used for filtering by sequence identity or for selecting additional
    templates (by randomly matching length).
- Metric files
    - _E.g._ B factors or OCDs used as quality filters.


### PDBs

I do not know 100% how the previous PDBs were selected. As of early 2019, we
are moving towards automating PDB cultivation. As we are not experts in
identifying antibodies from the PDB, we rely on SAbDab and pull the PDBs they
have cultivated (with resolution better than 3 Angstroms).

The PDBs are Chothia numbered and this is necessary because most antibody
code works under that assumption.

### BLAST Databases

BLAST databases are generated for the CDR L1, L2, L3, H1, H2, H3 regions, the
FRH and FRL regions, a combined "light-heavy" region for template selection.
For the CDRs, these database are separated by length. The FRH/L databases
should all be the same length (there are no variable insertions in the
framework regions). The "light-heavy" is a single database, but uses the full
sequence of the antibody for some reason, so it varies in length.

To generate the databases, sequences are extracted from the PDBs, assuming
Chothia numbering. One issue here is how to handle missing residues. The
current approach excludes regions if they are missing residues. Region
definitions (in the Chothia numbering scheme) are below. Definitions are
inclusive so H1 includes residue 26 and 35.

**Heavy-chain CDRs**
- H1: 26–35
- H2: 50–65
- H3: 95–102

**Light-chain CDRs**
- L1: 24–34
- L2: 50–56
- L3: 89–97

**Frameworks**
- FRH: 10–25, 36–39, 46–49, 66–94, 103–109
- FRL: 10–23, 35–39, 46–49, 57–66, 71–88, 98–104

**Light-heavy (orientation)**
- Heavy: 5–109
- Light: 5–104


### Info Files

The ranges above are used to extract sequences for the `antibody.info`,
`cdr.info`, `frh.info`, `frl.info`, and `frlh.info` files. In the older
database, some files use and underscore ("_") instead of a period ("."). These
info files are used to generate the BLAST database, except for `antibody.info`,
which is used by the C++ grafting code for filtering/appending results.

### Metrics for Filtering

Finally, there are several "quality" metrics antibody.cc uses to filter out
potential models. Previously, these came from three files: `list_bfactor50`,
`comparisons.txt`, and `outlier_list`. I must speculated on the origin of all
but one of these files. I know the `comparisons.txt` files contains OCD
(see Marze, Lyskov, and Gray [PEDS, 2016]) values for all pairs of antibodies.
These capture the orientation differences and were calculated using Nick's
pilot app (packing_angle, I think). I assume the `list_bfactor50` labels each
CDR region as "true" if that region either has a single (or average) B-factor
value above 50. I have no idea about the outlier list -- possibly it was there
to exclude antibodies that issues grafting? In the automated version of the
antibody database, I do not produce an outlier list.

### Conserved Residues

During grafting (grafter.cc line 182-ish), a set of conserved framework residues
is used to align the FRH and FRL templates to the orientation template. If these
residues are missing from templates, then this grafting step will fail. So,
when constructing the database, we check for the presence of the following
residues:

- **Heavy**
  - 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25,
  - 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49,
  - 66,
  - 69, 70, 71, 72,
  - 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94,
  - 103, 104, 105

- **Light**
  - 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,
  - 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49,
  - 57, 58, 59, 60, 61, 62, 63, 64, 65, 66,
  - 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88,
  - 98, 99, 100

## Current Status

There is now a single script (create_antibody_db.py) which will:

1. Download all sub-3.0 Angstrom antibody structures from SAbDab.
2. Select single Fab from each PDB and truncate to Fv.
3. Extract sequences for the above regions and check for structural issues.
4. Generate BLAST database from the info files (generated in step 3).
5. Calculated OCDs and extract B-factors.

Selecting a single Fv is not done rationally at the moment. In the future,
we should select by chain with most resolved regions rather than first reported
chain in SAbDab summary file.

The runtime is a bit slow as it loads PDBs into PyRosetta twice (steps 3 & 5).

The script probably can be optimized in a few ways as I initially just sought
to replicate the previous database.

### Replication of The Previous Database

It was not possible (why?) to perfectly replicate the previous database.
These statistics are as of Feb. 15th, 2019. Overall statistics indicate
an increase in template sources:

| Region | Old # | New # | Overlapping # |
| ------ | ----- | ----- | ------------- |
| All CDRs | 1902 | 2437 | 1497 |
| FRH | 1785 | 2365 | 1428 |
| FRL | 1577 | 1758 | 1109 |
| Orientation | 1003 | 1717 | 752 |

The overlapping PDBs could be used to compare sequences and metrics. I found
most PDBs agreed. Below I report mismatches and discuss a few reasons for them.

| Region | Mismatches |
| ------ | ---------- |
| CDR H1 | 30 |
| CDR H2 | 62 |
| CDR H3 | 35 |
| CDR L1 | 13 |
| CDR L2 | 16 |
| CDR L3 | 11 |
| FRH | 27 |
| FRL | 3 |
| Orientation | 11 |

**In general, mismatches occur at rates of ~1–2%, but why?**

For the H1, 3 loops are present in the new database, but not the old. These are
3qxu, 1yc7.pdb, and 1mvf.pdb. They are all single heavy chains. In the old
database they are missing atoms in the CDR H1 (why), hence they were excluded.

Again for the H1, 18 loops are present in the old, but not in the new, database.
These are:
`1ol0 4at6 3c5s 2p46 2p44 2p45 2p42 2p43 2p48 4tuj 4jzn 2p47 4y5y 4k3e 4jn2 1oay 1oax 1oau`.
These are a mix of antibodies. Spot checking a few: 4jzn, 4jn2, and 1oay have
missing atoms in the new H1. This indicates that we are not optimally selecting
H/L chains (because these breaks were not previously present).

Finally, for the H1, there are 9 loops with sequence mismatches:
`1pg7 4nzr 4krp 4rgn 4k7p 1n7m 5bv7 4nc1 3zkx`.
This is likely due to the presence of multiple antibodies in the PDB.
See 3zkx or 5bv7 as examples (I did not inspect all 9).
We currently, only select one (though we could do multiple by implementing
something like append an A/B/C... to the end of the PDB ID). Previously,
all Fvs were extracted for the info file, but only one appears to be present
in the PDB (which is a bad mistake because you might BLAST align to one thing
and then graft another). F

Metrics also do not match 100%. For the OCDs this is due to changes in which
chain is pulled from the PDB (when multiple chains are possible) because
the antibody structures will vary slightly across chains altering the PCA
results and the corresponding orientation metrics. For B-factors this is likely
because I do not use the same approach. Currently, I report the average B-factor
value across the entire loop (including side-chain atoms). I think the previous
approach set true/false if any backbone atom passed a threshold because my
current approach does not yield as many outliers.


## Future Directions

1. Is it necessary to use the whole light+heavy sequences for the orientation
alignment? Is this the best approach?
